<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BLE Lab (MVP-1)</title>
  <style>
    body { font-family: sans-serif; padding: 16px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { text-align: left; }
    .muted { opacity: 0.7; }
  </style>
</head>
<body>
  <h2>BLE Lab（MVP-1）</h2>

  <div class="row">
    <button id="btnScan">SCAN ZP2</button>
    <button id="btnFetch">讀取資訊（連線）</button>

    <label class="muted">
      <input type="checkbox" id="chkOnlyZp2" checked />
      只顯示 ZP2
    </label>

    <span id="status" class="muted"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:40px;"></th>
        <th>Address</th>
        <th>名稱</th>
        <th>RSSI</th>
        <th>AWS / LOCAL</th>
        <th>SSID</th>
        <th>MQTT地址</th>
        <th>IP地址</th>
        <th>型號</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

<script>
/* ===============================
 * Global state
 * =============================== */
let g_scan_devices = [];  // 最新 scan 的原始結果（只含 scan 資訊）
let g_devices = [];       // 目前顯示用資料（合併 details）

const statusEl = document.getElementById("status");
const tbody = document.getElementById("tbody");
const chkOnlyZp2 = document.getElementById("chkOnlyZp2");

/* ===============================
 * Helpers
 * =============================== */
function setStatus(msg) {
  statusEl.textContent = msg || "";
}

function clearTable() {
  tbody.innerHTML = "";
}

function applyFilter() {
  const only = chkOnlyZp2.checked;

  // 保留已經讀到的 details（ssid/mqtt/ip/model/mode）
  const oldMap = new Map(g_devices.map(x => [x.address, x]));

  g_devices = (g_scan_devices || [])
    .filter(d => !only || d.is_zp2)
    .map(d => ({
      ...d,
      ...(oldMap.get(d.address) || {})
    }));
}

function renderTable() {
  tbody.innerHTML = "";

  for (const d of g_devices) {
    const tr = document.createElement("tr");

    const tdChk = document.createElement("td");
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.dataset.addr = d.address;
    tdChk.appendChild(cb);

    function td(text) {
      const x = document.createElement("td");
      x.textContent =
        (text === null || text === undefined) ? "" : String(text);
      return x;
    }

    tr.appendChild(tdChk);
    tr.appendChild(td(d.address || ""));
    tr.appendChild(td(d.name || ""));
    tr.appendChild(td(
      (d.rssi === null || d.rssi === undefined) ? "" : d.rssi
    ));
    tr.appendChild(td(d.mode || ""));
    tr.appendChild(td(d.ssid || ""));
    tr.appendChild(td(d.mqtt || ""));
    tr.appendChild(td(d.ip || ""));
    tr.appendChild(td(d.model || ""));

    tbody.appendChild(tr);
  }
}

/* ===============================
 * Actions
 * =============================== */
async function scan() {
  clearTable();
  setStatus("掃描中...");

  const r = await fetch("/api/scan", { method: "POST" });
  const j = await r.json();

  setStatus(`掃描完成：${j.count} 台（ZP2: ${j.zp2_count}）`);

  g_scan_devices = (j.results || []);
  applyFilter();
  renderTable();
}

async function fetchDetails() {
  const targets = [];
  tbody.querySelectorAll("input[type=checkbox]").forEach(cb => {
    if (cb.checked) targets.push(cb.dataset.addr);
  });

  if (targets.length === 0) {
    setStatus("你沒有勾選任何裝置");
    return;
  }

  setStatus("讀取資訊中（逐台連線）...");

  const r = await fetch("/api/fetch_details", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ targets })
  });
  const j = await r.json();

  // 合併回 g_devices
  const map = new Map(g_devices.map(x => [x.address, x]));
  for (const it of (j.results || [])) {
    const old = map.get(it.address) || { address: it.address };
    map.set(it.address, { ...old, ...it });
  }
  g_devices = Array.from(map.values());

  renderTable();

  const fail = (j.results || []).find(x => !x.ok);
  if (fail) {
    setStatus(`讀取完成（部分失敗）：${fail.address} ${fail.error || ""}`);
  } else {
    setStatus("讀取完成（全部成功）");
  }
}

/* ===============================
 * Events
 * =============================== */
chkOnlyZp2.addEventListener("change", () => {
  applyFilter();
  renderTable();
});

document.getElementById("btnScan").onclick = scan;
document.getElementById("btnFetch").onclick = fetchDetails;
</script>

</body>
</html>
