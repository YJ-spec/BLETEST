<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BLE Lab (MVP-1)</title>
  <style>
    body { font-family: sans-serif; padding: 16px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { text-align: left; }
    .muted { opacity: 0.7; }
    .badge { display:inline-block; padding:2px 6px; border:1px solid #999; border-radius: 999px; font-size: 12px; }
  </style>
</head>
<body>
  <h2>BLE Lab（MVP-1）</h2>

  <div class="row">
    <button id="btnScan">SCAN ZP2</button>
    <button id="btnRefresh">刷新清單</button>
    <button id="btnApply">確認（儲存勾選）</button>
    <button id="btnProbe">Probe（讀取GATT）</button>
    <button id="btnFetch">讀取資訊（連線）</button>



    <label class="muted">
      <input type="checkbox" id="chkOnlyZp2" checked />
      只顯示 ZP2
    </label>

    <span id="status" class="muted"></span>
  </div>

  <table>
    <!-- <thead>
      <tr>
        <th style="width:40px;"></th>
        <th>Address</th>
        <th>Name/Alias</th>
        <th>RSSI</th>
        <th>ZP2</th>
      </tr>
    </thead> -->
    <thead>
      <tr>
        <th style="width:40px;"></th>
        <th>Address</th>
        <th>名稱</th>
        <th>RSSI</th>
        <th>AWS/LOCAL</th>
        <th>SSID</th>
        <th>MQTT地址</th>
        <th>IP地址</th>
        <th>型號</th>
        </tr>
    </thead>

    <tbody id="tbody"></tbody>
  </table>

  <h3>Probe Result</h3>
    <pre id="probeBox" style="border:1px solid #ddd; padding:12px; max-height: 360px; overflow:auto;"></pre>
    


<script>
let g_devices = []; // 目前表格資料

const statusEl = document.getElementById("status");
const tbody = document.getElementById("tbody");
const chkOnlyZp2 = document.getElementById("chkOnlyZp2");
const probeBox = document.getElementById("probeBox");

function setStatus(msg) { statusEl.textContent = msg; }

function clearTable() { tbody.innerHTML = ""; }

async function probe() {
  setStatus("Probe 中（逐台連線讀取 GATT）...");
  probeBox.textContent = "";

  // 先把目前勾選存檔（沿用 apply 行為）
  await apply();

  const r = await fetch("/api/probe", { method: "POST" });
  const j = await r.json();

  const rr = await fetch("/api/probe_result");
  const res = await rr.json();

  probeBox.textContent = JSON.stringify(res, null, 2);
  setStatus(`Probe 完成：${res.count} 台`);
}

document.getElementById("btnProbe").onclick = probe;
async function scan() {
  clearTable();
  setStatus("掃描中...");
  const r = await fetch("/api/scan", { method: "POST" });
  const j = await r.json();
  setStatus(`掃描完成：${j.count} 台（ZP2: ${j.zp2_count}）`);
  await refresh();
}


function renderTable() {
  tbody.innerHTML = "";
  for (const d of g_devices) {
    const tr = document.createElement("tr");

    const tdChk = document.createElement("td");
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.dataset.addr = d.address;
    tdChk.appendChild(cb);

    function td(text) {
      const x = document.createElement("td");
      x.textContent = (text === null || text === undefined) ? "" : String(text);
      return x;
    }

    tr.appendChild(tdChk);
    tr.appendChild(td(d.address || ""));
    tr.appendChild(td(d.name || ""));
    tr.appendChild(td((d.rssi === null || d.rssi === undefined) ? "" : d.rssi));
    tr.appendChild(td(d.mode || ""));
    tr.appendChild(td(d.ssid || ""));
    tr.appendChild(td(d.mqtt || ""));
    tr.appendChild(td(d.ip || ""));
    tr.appendChild(td(d.model || ""));

    tbody.appendChild(tr);
  }
}

async function refresh() {
  const only = chkOnlyZp2.checked ? "true" : "false";
  const r = await fetch(`/api/devices?only_zp2=${only}`);
  const j = await r.json();

  // 只更新 scan 得到的三欄，保留既有 details 欄位
  const oldMap = new Map(g_devices.map(x => [x.address, x]));
  g_devices = (j.devices || []).map(d => {
    const old = oldMap.get(d.address) || {};
    return { ...d, ...old, ...d }; // old 的 details 保留，scan 的 name/rssi 覆蓋
  });

  renderTable();

  if (j.expired) {
    setStatus(`清單已超過 ${j.ttl_sec}s，已清空`);
  } else {
    setStatus(`清單更新（age: ${j.age_sec}s / ttl: ${j.ttl_sec}s）`);
  }
}


async function fetchDetails() {
  const targets = [];
  tbody.querySelectorAll("input[type=checkbox]").forEach(cb => {
    if (cb.checked) targets.push(cb.dataset.addr);
  });

  if (targets.length === 0) {
    setStatus("你沒有勾選任何裝置");
    return;
  }

  setStatus("讀取資訊中（逐台連線）...");

  const r = await fetch("/api/fetch_details", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({targets})
  });
  const j = await r.json();

  // 合併回 g_devices
  const map = new Map(g_devices.map(x => [x.address, x]));
  for (const it of (j.results || [])) {
    const old = map.get(it.address) || { address: it.address };
    map.set(it.address, { ...old, ...it });
  }
  g_devices = Array.from(map.values());

  renderTable();

  // 如果有失敗的，顯示第一個錯誤（你之後要做 per-row error 也行）
  const fail = (j.results || []).find(x => !x.ok);
  if (fail) {
    setStatus(`讀取完成（部分失敗）：${fail.address} ${fail.error || ""}`);
  } else {
    setStatus("讀取完成（全部成功）");
  }
}

document.getElementById("btnFetch").onclick = fetchDetails;


async function apply() {
  const targets = [];
  tbody.querySelectorAll("input[type=checkbox]").forEach(cb => {
    if (cb.checked) targets.push(cb.dataset.addr);
  });

  if (targets.length === 0) {
    setStatus("你沒有勾選任何裝置");
    return;
  }

  const r = await fetch("/api/apply", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({targets})
  });
  const j = await r.json();
  setStatus(`已儲存 ${j.saved} 台`);
}

document.getElementById("btnScan").onclick = scan;
document.getElementById("btnRefresh").onclick = refresh;
document.getElementById("btnApply").onclick = apply;

refresh();
</script>
</body>
</html>
