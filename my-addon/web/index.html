<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BLE Lab (MVP-1)</title>
  <style>
    body { font-family: sans-serif; padding: 16px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { text-align: left; }
    .muted { opacity: 0.7; }

    .profile-bar {
      display: flex; align-items: center; justify-content: space-between;
      background: #f3f3f3; border: 1px solid #ccc;
      padding: 8px 12px; margin-bottom: 8px;
    }
    .profile-name { font-weight: bold; }
    .profile-panel {
      border: 1px solid #ccc; padding: 12px; margin-bottom: 12px;
      background: #fafafa;
    }
    .profile-panel.hidden { display: none; }
    .profile-row { margin-bottom: 8px; }
    .profile-row label { display: inline-block; width: 100px; font-weight: bold; }
    .profile-actions { margin-top: 12px; display: flex; gap: 8px; }
  </style>
</head>

<body>
  <h2>BLE Lab（MVP-1）</h2>

  <!-- ================= Profile Panel ================= -->
  <div id="profileContainer">
    <div class="profile-bar">
      <div>
        目前設定檔：
        <span id="currentProfileName" class="profile-name">未選擇</span>
      </div>
      <button id="btnToggleProfile">展開設定 ▾</button>
    </div>

    <div id="profilePanel" class="profile-panel hidden">
      <div class="profile-row">
        <label>Profile：</label>
        <select id="profileSelect">
          <option value="">(尚未選擇)</option>
        </select>
      </div>

      <div class="profile-row">
        <label>Profile ID：</label>
        <input id="profileId" type="text" placeholder="line1_local" />
      </div>

      <div class="profile-row">
        <label>顯示名稱：</label>
        <input id="profileName" type="text" placeholder="產線1 - LOCAL" />
      </div>

      <hr />

      <div class="profile-row">
        <label>模式：</label>
        <label>
          <input type="radio" name="profileMode" value="LOCAL" checked />
          LOCAL
        </label>
        <label style="margin-left:12px;">
          <input type="radio" name="profileMode" value="AWS" />
          AWS
        </label>
      </div>

      <div class="profile-row">
        <label>SSID：</label>
        <input id="profileSsid" type="text" />
      </div>

      <div class="profile-row">
        <label>密碼：</label>
        <input id="profilePassword" type="text" />
      </div>

      <div class="profile-row">
        <label>MQTT：</label>
        <input id="profileMqtt" type="text" style="width: 360px;" />
      </div>

      <div class="profile-actions">
        <button id="btnProfileNew">全新</button>
        <button id="btnProfileSave">儲存（覆蓋）</button>
        <button id="btnProfileSaveAs">另存新檔</button>
        <button id="btnProfileDelete">刪除</button>
      </div>
    </div>
  </div>
  <!-- =============== End Profile Panel =============== -->

  <div class="row">
    <button id="btnScan">SCAN ZP2</button>
    <button id="btnFetch">讀取資訊（連線）</button>
    <button id="btnWrite">寫入設定（SEND）</button>

    <label class="muted">
      <input type="checkbox" id="chkOnlyZp2" checked />
      只顯示 ZP2
    </label>

    <span id="status" class="muted"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:40px;">
          <input type="checkbox" id="chkAll" title="全選/全不選" />
        </th>
        <th>Address</th>
        <th>名稱</th>
        <th>RSSI</th>
        <th>AWS / LOCAL</th>
        <th>SSID</th>
        <th>MQTT地址</th>
        <th>IP地址</th>
        <th>型號</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    /* ===============================
     * Global state
     * =============================== */
    let g_scan_devices = [];  // 最新 scan 的原始結果（只含 scan 資訊）
    let g_devices = [];       // 目前顯示用資料（合併 details）
    let g_selected_addrs = new Set(); // 記住哪些 address 被勾選（重繪表格不會消失）

    const statusEl = document.getElementById("status");
    const tbody = document.getElementById("tbody");
    const chkOnlyZp2 = document.getElementById("chkOnlyZp2");
    const chkAll = document.getElementById("chkAll");

    /* ===============================
     * Profile UI elements
     * =============================== */
    const btnToggleProfile = document.getElementById("btnToggleProfile");
    const profilePanel = document.getElementById("profilePanel");
    const currentProfileName = document.getElementById("currentProfileName");

    const profileSelect = document.getElementById("profileSelect");
    const profileIdEl = document.getElementById("profileId");
    const profileNameEl = document.getElementById("profileName");
    const profileSsidEl = document.getElementById("profileSsid");
    const profilePasswordEl = document.getElementById("profilePassword");
    const profileMqttEl = document.getElementById("profileMqtt");

    const btnProfileNew = document.getElementById("btnProfileNew");
    const btnProfileSave = document.getElementById("btnProfileSave");
    const btnProfileSaveAs = document.getElementById("btnProfileSaveAs");
    const btnProfileDelete = document.getElementById("btnProfileDelete");

    function getSelectedMode() {
      const el = document.querySelector('input[name="profileMode"]:checked');
      return el ? el.value : "LOCAL";
    }
    function setSelectedMode(mode) {
      const v = (mode === "AWS") ? "AWS" : "LOCAL";
      const el = document.querySelector(`input[name="profileMode"][value="${v}"]`);
      if (el) el.checked = true;
    }

    /* ===============================
     * Helpers
     * =============================== */
    function setStatus(msg) { statusEl.textContent = msg || ""; }
    function clearTable() { tbody.innerHTML = ""; }
    function setCurrentProfileName(name) { currentProfileName.textContent = name || "未選擇"; }

    function applyFilter() {
      const only = chkOnlyZp2.checked;
      const oldMap = new Map(g_devices.map(x => [x.address, x])); // 保留 details
      g_devices = (g_scan_devices || [])
        .filter(d => !only || d.is_zp2)
        .map(d => ({ ...d, ...(oldMap.get(d.address) || {}) }));
    }

    function renderTable() {
      tbody.innerHTML = "";

      function syncHeaderCheckState() {
        const boxes = tbody.querySelectorAll('input[type="checkbox"][data-addr]');
        if (!chkAll) return;

        if (boxes.length === 0) {
          chkAll.checked = false;
          chkAll.indeterminate = false;
          return;
        }

        let checkedCount = 0;
        boxes.forEach(cb => { if (cb.checked) checkedCount++; });

        chkAll.checked = checkedCount === boxes.length;
        chkAll.indeterminate = checkedCount > 0 && checkedCount < boxes.length;
      }

      function td(text) {
        const x = document.createElement("td");
        x.textContent = (text === null || text === undefined) ? "" : String(text);
        return x;
      }

      for (const d of g_devices) {
        const tr = document.createElement("tr");
        tr.style.cursor = "pointer";

        const tdChk = document.createElement("td");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.dataset.addr = d.address;

        cb.checked = !!d.address && g_selected_addrs.has(d.address);

        cb.addEventListener("click", (e) => e.stopPropagation());
        cb.addEventListener("change", () => {
          if (!d.address) return;
          if (cb.checked) g_selected_addrs.add(d.address);
          else g_selected_addrs.delete(d.address);
          syncHeaderCheckState();
        });

        tdChk.appendChild(cb);

        tr.appendChild(tdChk);
        tr.appendChild(td(d.address || ""));
        tr.appendChild(td(d.name || ""));
        tr.appendChild(td((d.rssi === null || d.rssi === undefined) ? "" : d.rssi));
        tr.appendChild(td(d.mode || ""));
        tr.appendChild(td(d.ssid || ""));
        tr.appendChild(td(d.mqtt || ""));
        tr.appendChild(td(d.ip || ""));
        tr.appendChild(td(d.model || ""));

        tr.addEventListener("click", () => {
          if (!d.address) return;
          cb.checked = !cb.checked;
          if (cb.checked) g_selected_addrs.add(d.address);
          else g_selected_addrs.delete(d.address);
          syncHeaderCheckState();
        });

        tr.addEventListener("dblclick", async () => {
          if (!d.address) return;
          g_selected_addrs.add(d.address);
          cb.checked = true;
          syncHeaderCheckState();
          await fetchDetails();
        });

        tbody.appendChild(tr);
      }

      syncHeaderCheckState();
    }

    /* ===============================
     * Profile storage (SERVER: /data/profiles.json)
     * =============================== */
    async function apiGetProfilesDoc() {
      const r = await fetch("/api/profiles");
      return await r.json(); // {schema, current_profile_id, profiles:[]}
    }

    async function apiUpsertProfile(profile, overwrite_id = null) {
      const r = await fetch("/api/profiles/upsert", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ profile, overwrite_id })
      });
      return await r.json(); // {ok, id, doc} or {ok:false,error}
    }

    async function apiSelectProfile(id) {
      const r = await fetch("/api/profiles/select", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: id || "" })
      });
      return await r.json(); // {ok,id} or {ok:false,error}
    }

    async function apiDeleteProfile(id) {
      const r = await fetch(`/api/profiles/${encodeURIComponent(id)}`, { method: "DELETE" });
      return await r.json(); // {ok,doc} or {ok:false,error}
    }

    async function loadProfiles() {
      const doc = await apiGetProfilesDoc();
      return doc.profiles || [];
    }

    async function getCurrentProfileId() {
      const doc = await apiGetProfilesDoc();
      return doc.current_profile_id || "";
    }

    async function setCurrentProfileId(id) {
      const r = await apiSelectProfile(id || "");
      if (!r.ok) {
        setStatus(r.error || "切換 Profile 失敗");
        return false;
      }
      return true;
    }

    function profileFromForm() {
      return {
        id: (profileIdEl.value || "").trim(),
        name: (profileNameEl.value || "").trim(),
        mode: getSelectedMode(),
        ssid: (profileSsidEl.value || "").trim(),
        password: (profilePasswordEl.value || "").trim(),
        mqtt: (profileMqttEl.value || "").trim(),
        updated_at: Date.now()
      };
    }

    function fillFormFromProfile(p) {
      profileIdEl.value = p?.id || "";
      profileNameEl.value = p?.name || "";
      setSelectedMode(p?.mode || "LOCAL");
      profileSsidEl.value = p?.ssid || "";
      profilePasswordEl.value = p?.password || "";
      profileMqttEl.value = p?.mqtt || "";
    }

    async function refreshProfileSelect() {
      const profiles = await loadProfiles();
      const curId = await getCurrentProfileId();

      profileSelect.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "(尚未選擇)";
      profileSelect.appendChild(opt0);

      for (const p of profiles) {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = `${p.name || p.id || "(未命名)"}${p.mode ? ` [${p.mode}]` : ""}`;
        profileSelect.appendChild(opt);
      }

      profileSelect.value = curId || "";
    }

    async function findProfileById(id) {
      const profiles = await loadProfiles();
      return profiles.find(p => p.id === id) || null;
    }

    async function getCurrentProfile() {
      const curId = await getCurrentProfileId();
      if (!curId) return null;
      return await findProfileById(curId);
    }

    async function upsertProfile(p, overwriteId = null) {
      const id = (overwriteId || p.id || "").trim();
      if (!id) { setStatus("Profile ID 不能為空"); return false; }

      const r = await apiUpsertProfile(p, overwriteId || null);
      if (!r.ok) { setStatus(r.error || "儲存失敗"); return false; }

      await refreshProfileSelect();

      const cur = await getCurrentProfile();
      if (cur) setCurrentProfileName(cur.name || cur.id);
      else setCurrentProfileName("未選擇");

      return true;
    }

    async function deleteProfile(id) {
      const r = await apiDeleteProfile(id);
      if (!r.ok) { setStatus(r.error || "刪除失敗"); return; }

      await refreshProfileSelect();

      const cur = await getCurrentProfile();
      if (cur) {
        fillFormFromProfile(cur);
        setCurrentProfileName(cur.name || cur.id);
      } else {
        setCurrentProfileName("未選擇");
      }
    }

    async function ensureDefaultProfiles() {
      const doc = await apiGetProfilesDoc();
      const profiles = doc.profiles || [];
      if (profiles.length > 0) return;

      const demo = [
        { id: "line1_local", name: "產線1 - LOCAL", mode: "LOCAL", ssid: "", password: "", mqtt: "10.10.10.10", updated_at: Date.now() }
      ];

      for (const p of demo) await apiUpsertProfile(p, p.id);
      await apiSelectProfile(""); // demo 建好但預設「未選擇」
    }

    /* ===============================
     * Actions: BLE scan / fetch details
     * =============================== */
    async function scan() {
      clearTable();
      setStatus("掃描中...");

      const r = await fetch("/api/scan", { method: "POST" });
      const j = await r.json();

      setStatus(`掃描完成：${j.count} 台（ZP2: ${j.zp2_count}）`);

      g_scan_devices = (j.results || []);
      const alive = new Set((g_scan_devices || []).map(x => x.address).filter(Boolean));
      g_selected_addrs = new Set([...g_selected_addrs].filter(a => alive.has(a)));

      applyFilter();
      renderTable();
    }

    async function fetchDetails() {
      const targets = Array.from(g_selected_addrs);
      if (targets.length === 0) { setStatus("你沒有勾選任何裝置"); return; }

      setStatus("讀取資訊中（逐台連線）...");

      // ⚠️ 注意：後端 /api/fetch_details 目前只宣告 targets
      // 這裡「不送 profile」最安全（避免 422）
      const r = await fetch("/api/fetch_details", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ targets })
      });
      const j = await r.json();

      const map = new Map(g_devices.map(x => [x.address, x]));
      for (const it of (j.results || [])) {
        const old = map.get(it.address) || { address: it.address };
        map.set(it.address, { ...old, ...it });
      }
      g_devices = Array.from(map.values());

      renderTable();

      const fail = (j.results || []).find(x => !x.ok);
      if (fail) setStatus(`讀取完成（部分失敗）：${fail.address} ${fail.error || ""}`);
      else setStatus("讀取完成（全部成功）");
    }
    async function writeProfile() {
  const targets = Array.from(g_selected_addrs);
  if (targets.length === 0) { setStatus("你沒有勾選任何裝置"); return; }

  const pid = (profileSelect.value || "").trim();
  if (!pid) { setStatus("請先選擇 Profile（上方下拉選單）"); return; }

  setStatus("寫入中（逐台連線）...");

  const r = await fetch("/api/write_profile", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ targets, profile_id: pid })
  });

  const j = await r.json();

  if (!j.ok) {
    setStatus(j.error || "寫入失敗");
    return;
  }

  const fail = (j.results || []).find(x => !x.ok);
  if (fail) setStatus(`寫入完成（部分失敗）：${fail.address} ${fail.error || ""}`);
  else setStatus("寫入完成（全部成功）");

  // 寫完順便讀回來更新表格（你也可以不要這行）
  await fetchDetails();
}


    /* ===============================
     * Events
     * =============================== */
    chkOnlyZp2.addEventListener("change", () => { applyFilter(); renderTable(); });

    if (chkAll) {
      chkAll.addEventListener("change", () => {
        const boxes = tbody.querySelectorAll('input[type="checkbox"][data-addr]');
        const want = chkAll.checked;

        boxes.forEach(cb => {
          cb.checked = want;
          const addr = cb.dataset.addr;
          if (!addr) return;
          if (want) g_selected_addrs.add(addr);
          else g_selected_addrs.delete(addr);
        });

        chkAll.indeterminate = false;
      });
    }

    document.getElementById("btnScan").onclick = scan;
    document.getElementById("btnFetch").onclick = fetchDetails;
    document.getElementById("btnWrite").onclick = writeProfile;


    let profileExpanded = false;
    btnToggleProfile.onclick = () => {
      profileExpanded = !profileExpanded;
      profilePanel.classList.toggle("hidden", !profileExpanded);
      btnToggleProfile.textContent = profileExpanded ? "收合設定 ▴" : "展開設定 ▾";
    };

    profileSelect.addEventListener("change", async () => {
      const id = profileSelect.value || "";
      await setCurrentProfileId(id);

      if (!id) { setCurrentProfileName("未選擇"); return; }

      const p = await findProfileById(id);
      if (!p) { setCurrentProfileName("未選擇"); return; }

      fillFormFromProfile(p);
      setCurrentProfileName(p.name || p.id);
      setStatus(`已切換設定檔：${p.name || p.id}`);
    });

    btnProfileNew.onclick = async () => {
      profileSelect.value = "";
      await setCurrentProfileId("");
      fillFormFromProfile({ id: "", name: "", mode: "LOCAL", ssid: "", password: "", mqtt: "" });
      setCurrentProfileName("未選擇");
      setStatus("已清空表單（尚未儲存）");
    };

    btnProfileSave.onclick = async () => {
      const curSelected = profileSelect.value || "";
      const p = profileFromForm();
      const targetId = curSelected || p.id;

      if (!targetId) { setStatus("請先選擇要覆蓋的 Profile，或填入 Profile ID"); return; }

      const ok = await upsertProfile(p, targetId);
      if (ok) {
        profileSelect.value = targetId;
        setStatus(`已儲存（覆蓋）：${targetId}`);
      }
    };

    btnProfileSaveAs.onclick = async () => {
      const p = profileFromForm();
      if (!p.id) { setStatus("另存新檔需要填 Profile ID"); return; }

      const exists = await findProfileById(p.id);
      if (exists) { setStatus("這個 Profile ID 已存在，請換一個（或用『儲存（覆蓋）』）"); return; }

      const ok = await upsertProfile(p, p.id);
      if (ok) {
        profileSelect.value = p.id;
        setStatus(`已另存新檔：${p.id}`);
      }
    };

    btnProfileDelete.onclick = async () => {
      const id = profileSelect.value || "";
      if (!id) { setStatus("請先選擇要刪除的 Profile"); return; }

      const p = await findProfileById(id);
      const name = p?.name || id;
      const yes = confirm(`確定要刪除「${name}」嗎？`);
      if (!yes) return;

      await deleteProfile(id);
      setStatus(`已刪除：${name}`);
    };

    /* ===============================
     * Boot
     * =============================== */
    (async () => {
      await ensureDefaultProfiles();
      await refreshProfileSelect();

      const curId = await getCurrentProfileId();
      if (curId) {
        const p = await findProfileById(curId);
        if (p) {
          fillFormFromProfile(p);
          setCurrentProfileName(p.name || p.id);
          profileSelect.value = curId;
        } else {
          setCurrentProfileName("未選擇");
        }
      } else {
        setCurrentProfileName("未選擇");
      }
    })();
  </script>

</body>
</html>
